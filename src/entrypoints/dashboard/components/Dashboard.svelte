<script lang="ts">
  import {getTinyContextForce, useTable} from "@/lib/tinybase/tinybase-stores";
  import {Button, Heading, Modal, TableBody, TableHead, TableHeadCell, TableSearch} from "flowbite-svelte";
  import {createMergeableStore, type MergeableStore} from "tinybase";
  import {download, pickFile, readFileText} from "@/lib/misc/browser-file";
  import MediaAdmin from "@/entrypoints/dashboard/components/MediaAdmin.svelte";
  import type {Loop, Media} from "@/lib/model";
  import YoutubeEmbed from "@/lib/components/YoutubeEmbed.svelte";
  import {parseEDNString} from "edn-data";
  import {keep} from "@/lib/helpers/array";
  import ImportEntry from "@/entrypoints/dashboard/components/ImportEntry.svelte";
  import {sourceIdFromVideoId} from "@/lib/youtube/ui";

  const store = getTinyContextForce('store') as MergeableStore

  const storageContents = JSON.parse('{"\\"media-looper:youtube:-XYBowmr5aw\\"":"[{:com.wsscode.media-looper.model/loop-id #uuid \\"7ffacb3e-e429-49c9-9234-a12a2967114d\\", :com.wsscode.media-looper.model/loop-title \\"New loop\\", :com.wsscode.media-looper.model/loop-start 31.765434, :com.wsscode.media-looper.model/loop-finish 45.929323999999994}]","\\"media-looper:youtube:-n0_YQKLMzQ\\"":"[{:com.wsscode.media-looper.model/loop-id #uuid \\"cfe1d132-9977-4b8b-9493-f3760e3aed53\\", :com.wsscode.media-looper.model/loop-title \\"Intro 1/2\\", :com.wsscode.media-looper.model/loop-start 279.954931, :com.wsscode.media-looper.model/loop-finish 293.029286} {:com.wsscode.media-looper.model/loop-id #uuid \\"110aa4b8-c97c-412c-bbcd-c880ad2e524e\\", :com.wsscode.media-looper.model/loop-title \\"Intro 2/2\\", :com.wsscode.media-looper.model/loop-start 392.957844, :com.wsscode.media-looper.model/loop-finish 406.122} {:com.wsscode.media-looper.model/loop-id #uuid \\"76e324be-45ed-40a0-b923-0bbb91739e83\\", :com.wsscode.media-looper.model/loop-title \\"Intro\\", :com.wsscode.media-looper.model/loop-start 233.534814, :com.wsscode.media-looper.model/loop-finish 246.421785} {:com.wsscode.media-looper.model/loop-id #uuid \\"8f44ccc3-5ac0-4981-afbc-209a0e61e4f5\\", :com.wsscode.media-looper.model/loop-title \\"Primeira parte tabs\\", :com.wsscode.media-looper.model/loop-start 478.008836, :com.wsscode.media-looper.model/loop-finish 526.152738} {:com.wsscode.media-looper.model/loop-id #uuid \\"fdc142c4-4c5e-491e-9a8e-21d6505d3a2e\\", :com.wsscode.media-looper.model/loop-title \\"Primeira parte\\", :com.wsscode.media-looper.model/loop-start 447.539325, :com.wsscode.media-looper.model/loop-finish 473.791614} {:com.wsscode.media-looper.model/loop-id #uuid \\"8b03ce60-aea0-402e-8522-abf7a48b109d\\", :com.wsscode.media-looper.model/loop-title \\"Segunda Parte\\", :com.wsscode.media-looper.model/loop-start 656.688495, :com.wsscode.media-looper.model/loop-finish 682.915161} {:com.wsscode.media-looper.model/loop-id #uuid \\"b7b9bbd0-4810-4847-bc1f-22dca7b04fcf\\", :com.wsscode.media-looper.model/loop-title \\"Segunda parte tabs\\", :com.wsscode.media-looper.model/loop-start 686.479066, :com.wsscode.media-looper.model/loop-finish 733.077305} {:com.wsscode.media-looper.model/loop-id #uuid \\"b80ffb65-cdee-4260-b99f-f9f61df91db9\\", :com.wsscode.media-looper.model/loop-title \\"Am6 -> A\\", :com.wsscode.media-looper.model/loop-start 704.169195, :com.wsscode.media-looper.model/loop-finish 709.2191699999998} {:com.wsscode.media-looper.model/loop-id #uuid \\"e2d4def5-c723-4807-aab9-78f6c22f3c9a\\", :com.wsscode.media-looper.model/loop-title \\"Terceira parte tabs\\", :com.wsscode.media-looper.model/loop-start 997.646315, :com.wsscode.media-looper.model/loop-finish 1044.499928} {:com.wsscode.media-looper.model/loop-id #uuid \\"01a7bc4a-ae95-4383-b914-afca1fba0acd\\", :com.wsscode.media-looper.model/loop-title \\"Terceira parte\\", :com.wsscode.media-looper.model/loop-start 966.659068, :com.wsscode.media-looper.model/loop-finish 993.0151799999999} {:com.wsscode.media-looper.model/loop-id #uuid \\"6afef9bf-8c3e-41d4-9fea-dea4f176cb6e\\", :com.wsscode.media-looper.model/loop-title \\"Musica Inteira\\", :com.wsscode.media-looper.model/loop-start 4.833714, :com.wsscode.media-looper.model/loop-finish 138.40545} {:com.wsscode.media-looper.model/loop-id #uuid \\"db1e786f-c74a-48a7-86d1-033d3de47539\\", :com.wsscode.media-looper.model/loop-title \\"Terceira parte tabs 1/4\\", :com.wsscode.media-looper.model/loop-start 997.646315, :com.wsscode.media-looper.model/loop-finish 1009.37304} {:com.wsscode.media-looper.model/loop-id #uuid \\"c312e8d6-a01a-4ffc-a0c2-450bcb58c029\\", :com.wsscode.media-looper.model/loop-title \\"Intro Completa\\", :com.wsscode.media-looper.model/loop-start 279.954, :com.wsscode.media-looper.model/loop-finish 406.123} {:com.wsscode.media-looper.model/loop-id #uuid \\"48b6cbad-ea06-4dcc-9bcc-a29fe8e49676\\", :com.wsscode.media-looper.model/loop-title \\"Quarta parte\\", :com.wsscode.media-looper.model/loop-start 1207.326537, :com.wsscode.media-looper.model/loop-finish 1251.274657} {:com.wsscode.media-looper.model/loop-id #uuid \\"78ccf2b6-c7c2-47b7-8509-b7995199ed5c\\", :com.wsscode.media-looper.model/loop-title \\"Quarta parte tabs\\", :com.wsscode.media-looper.model/loop-start 1257.123781, :com.wsscode.media-looper.model/loop-finish 1332.961156} {:com.wsscode.media-looper.model/loop-id #uuid \\"0e08f713-8478-4a7d-bed8-923ab6f41d13\\", :com.wsscode.media-looper.model/loop-title \\"Refrao Segunda Estrofe - 4/6\\", :com.wsscode.media-looper.model/loop-start 1292.214788, :com.wsscode.media-looper.model/loop-finish 1303.232002}]","\\"media-looper:youtube:3Rx620Qeowc\\"":"[{:com.wsscode.media-looper.model/loop-id #uuid \\"baf3b65a-2fed-4519-9cd3-f5b7faa402ab\\", :com.wsscode.media-looper.model/loop-title \\"Primeira Parte Completa\\", :com.wsscode.media-looper.model/loop-start 600.893468, :com.wsscode.media-looper.model/loop-finish 671.595161} {:com.wsscode.media-looper.model/loop-id #uuid \\"860dc8db-1613-44d2-a958-ffbaa045ae9c\\", :com.wsscode.media-looper.model/loop-title \\"Primeira Parte 1/11\\", :com.wsscode.media-looper.model/loop-start 600.893468, :com.wsscode.media-looper.model/loop-finish 606.6999999999999} {:com.wsscode.media-looper.model/loop-id #uuid \\"7ec7c5d8-0874-40e6-a4c8-ea3869f54b69\\", :com.wsscode.media-looper.model/loop-title \\"Primeira Parte 1 - 5\\", :com.wsscode.media-looper.model/loop-start 600.893468, :com.wsscode.media-looper.model/loop-finish 631.149}]","\\"media-looper:youtube:67PV7dHypBc\\"":"[{:com.wsscode.media-looper.model/loop-id #uuid \\"c29dc9fd-6345-43c0-b5ef-f89f652939ea\\", :com.wsscode.media-looper.model/loop-title \\"New loop\\", :com.wsscode.media-looper.model/loop-start 9.239458, :com.wsscode.media-looper.model/loop-finish 31.294753} {:com.wsscode.media-looper.model/loop-id #uuid \\"746e1b5b-47b0-467d-97ec-e3f0281e0e99\\", :com.wsscode.media-looper.model/loop-title \\"New loop\\", :com.wsscode.media-looper.model/loop-start 47.82766, :com.wsscode.media-looper.model/loop-finish 67.915949}]","\\"media-looper:youtube:6PeW_G0PFb4\\"":"[{:com.wsscode.media-looper.model/loop-id #uuid \\"d534ce70-a100-47d7-848f-97e146c94be3\\", :com.wsscode.media-looper.model/loop-title \\"First Chord\\", :com.wsscode.media-looper.model/loop-start 0, :com.wsscode.media-looper.model/loop-finish 1.141264} {:com.wsscode.media-looper.model/loop-id #uuid \\"26a39a3a-c106-41d8-b65b-3451f6c3a530\\", :com.wsscode.media-looper.model/loop-title \\"First block\\", :com.wsscode.media-looper.model/loop-start 0, :com.wsscode.media-looper.model/loop-finish 4.047916, :com.wsscode.media-looper.model/children [{:com.wsscode.media-looper.model/loop-id #uuid \\"d534ce70-a100-47d7-848f-97e146c94be3\\", :com.wsscode.media-looper.model/loop-title \\"First Chord\\", :com.wsscode.media-looper.model/loop-start 0, :com.wsscode.media-looper.model/loop-finish 1.141264}]}]","\\"media-looper:youtube:6d6fIM54Vkk\\"":"[{:com.wsscode.media-looper.model/loop-id #uuid \\"f095224b-7223-4cb6-8b05-946935401ac4\\", :com.wsscode.media-looper.model/loop-title \\"New loop\\", :com.wsscode.media-looper.model/loop-start 32.47357, :com.wsscode.media-looper.model/loop-finish 42.859283} {:com.wsscode.media-looper.model/loop-id #uuid \\"4d3e6c3d-31ac-42e8-87a3-003e7893c7a5\\", :com.wsscode.media-looper.model/loop-title \\"Chorus\\", :com.wsscode.media-looper.model/loop-start 120.313984, :com.wsscode.media-looper.model/loop-finish 147.066973}]","\\"media-looper:youtube:8ErTyC6jLlY\\"":"[{:com.wsscode.media-looper.model/loop-id #uuid \\"085f969d-8f99-43a9-b25e-9a9cf710635e\\", :com.wsscode.media-looper.model/loop-title \\"New loop\\", :com.wsscode.media-looper.model/loop-start 21.106274, :com.wsscode.media-looper.model/loop-finish 26.010078} {:com.wsscode.media-looper.model/loop-id #uuid \\"c47d0398-5fd2-4e4f-929d-91e86e424ecc\\", :com.wsscode.media-looper.model/loop-title \\"New loop\\", :com.wsscode.media-looper.model/loop-start 21.106274, :com.wsscode.media-looper.model/loop-finish 36.31007799999999, :com.wsscode.media-looper.model/children [{:com.wsscode.media-looper.model/loop-id #uuid \\"085f969d-8f99-43a9-b25e-9a9cf710635e\\", :com.wsscode.media-looper.model/loop-title \\"New loop\\", :com.wsscode.media-looper.model/loop-start 21.106274, :com.wsscode.media-looper.model/loop-finish 26.010078}]}]","\\"media-looper:youtube:B_XTyYWLRmk\\"":"[{:com.wsscode.media-looper.model/loop-id #uuid \\"293c6fb2-a49f-46dd-ae2e-6e29fe0efc77\\", :com.wsscode.media-looper.model/loop-title \\"Musica Inteira\\", :com.wsscode.media-looper.model/loop-start 4.557021, :com.wsscode.media-looper.model/loop-finish 176.117281}]","\\"media-looper:youtube:D3a-43LRqXA\\"":"[{:com.wsscode.media-looper.model/loop-id #uuid \\"e290e288-c157-4517-9ed9-4e626f1a415e\\", :com.wsscode.media-looper.model/loop-title \\"New loop\\", :com.wsscode.media-looper.model/loop-start 37.976468, :com.wsscode.media-looper.model/loop-finish 44.389199} {:com.wsscode.media-looper.model/loop-id #uuid \\"cd90ac5d-c3cc-4aba-9aef-c986fc0aeed9\\", :com.wsscode.media-looper.model/loop-title \\"New loop\\", :com.wsscode.media-looper.model/loop-start 42.976468, :com.wsscode.media-looper.model/loop-finish 44.389199} {:com.wsscode.media-looper.model/loop-id #uuid \\"f80a82f8-14ec-4018-839b-3e18ed5b6946\\", :com.wsscode.media-looper.model/loop-title \\"New loop\\", :com.wsscode.media-looper.model/loop-start 44.393205, :com.wsscode.media-looper.model/loop-finish 51.345709} {:com.wsscode.media-looper.model/loop-id #uuid \\"7904187e-4da8-42a9-ae81-cf7658b066ae\\", :com.wsscode.media-looper.model/loop-title \\"New loop\\", :com.wsscode.media-looper.model/loop-start 47.225123, :com.wsscode.media-looper.model/loop-finish 47.77593899999999}]","\\"media-looper:youtube:ELcI2XWFT6Q\\"":"[{:com.wsscode.media-looper.model/loop-id #uuid \\"444ce73d-f88a-4bae-aa11-8355fee10177\\", :com.wsscode.media-looper.model/loop-title \\"Musica Inteira\\", :com.wsscode.media-looper.model/loop-start 29.793927, :com.wsscode.media-looper.model/loop-finish 99.900867} {:com.wsscode.media-looper.model/loop-id #uuid \\"671feae2-bfb4-4059-8537-387b5a2f5941\\", :com.wsscode.media-looper.model/loop-title \\"Intro\\", :com.wsscode.media-looper.model/loop-start 160.223249, :com.wsscode.media-looper.model/loop-finish 171.72799} {:com.wsscode.media-looper.model/loop-id #uuid \\"ed60b2a8-33ba-401e-8d31-a4e568c41bb3\\", :com.wsscode.media-looper.model/loop-title \\"Verso 1\\", :com.wsscode.media-looper.model/loop-start 590.998144, :com.wsscode.media-looper.model/loop-finish 602.430232} {:com.wsscode.media-looper.model/loop-id #uuid \\"6d19117c-250b-4e9d-9d77-a7080341cb50\\", :com.wsscode.media-looper.model/loop-title \\"Verso 2\\", :com.wsscode.media-looper.model/loop-start 650.642576, :com.wsscode.media-looper.model/loop-finish 660.841946} {:com.wsscode.media-looper.model/loop-id #uuid \\"5fbf01f1-ecc2-4f2c-8340-9655ca16de0b\\", :com.wsscode.media-looper.model/loop-title \\"Verso 3\\", :com.wsscode.media-looper.model/loop-start 784.1899129999999, :com.wsscode.media-looper.model/loop-finish 795.569525} {:com.wsscode.media-looper.model/loop-id #uuid \\"fe6c038b-b872-4924-8796-80f09b8a68b4\\", :com.wsscode.media-looper.model/loop-title \\"Versos 4 e 5\\", :com.wsscode.media-looper.model/loop-start 932.715161, :com.wsscode.media-looper.model/loop-finish 948.350109} {:com.wsscode.media-looper.model/loop-id #uuid \\"bd0a8ccf-3dfb-45a5-8e79-c9068d6f6a94\\", :com.wsscode.media-looper.model/loop-title \\"Verso 6\\", :com.wsscode.media-looper.model/loop-start 1119.463384, :com.wsscode.media-looper.model/loop-finish 1129.697689} {:com.wsscode.media-looper.model/loop-id #uuid \\"8818d98b-16d4-45bc-8f88-8d169047c0f2\\", :com.wsscode.media-looper.model/loop-title \\"Verso 7\\", :com.wsscode.media-looper.model/loop-start 1240.2435539999997, :com.wsscode.media-looper.model/loop-finish 1251.158481} {:com.wsscode.media-looper.model/loop-id #uuid \\"2cadab7f-43bf-4c82-a46e-1051a00f0e23\\", :com.wsscode.media-looper.model/loop-title \\"Verso 8\\", :com.wsscode.media-looper.model/loop-start 1417.8405339999997, :com.wsscode.media-looper.model/loop-finish 1428.2466980000004} {:com.wsscode.media-looper.model/loop-id #uuid \\"566f44e9-c484-4112-8f4b-4b091ba42235\\", :com.wsscode.media-looper.model/loop-title \\"Parte 2\\", :com.wsscode.media-looper.model/loop-start 1245.065423, :com.wsscode.media-looper.model/loop-finish 1250.038472}]","\\"media-looper:youtube:GCecTk6q0m0\\"":"[{:com.wsscode.media-looper.model/loop-id #uuid \\"1754b367-05fe-4206-99fb-738089c8ff0c\\", :com.wsscode.media-looper.model/loop-title \\"Intro\\", :com.wsscode.media-looper.model/loop-start 0, :com.wsscode.media-looper.model/loop-finish 17.310167}]","\\"media-looper:youtube:GJm7H9IP5SU\\"":"[{:com.wsscode.media-looper.model/loop-id #uuid \\"09d2a40b-eb6d-4073-82ed-afb8eb74a2be\\", :com.wsscode.media-looper.model/loop-title \\"New loop\\", :com.wsscode.media-looper.model/loop-start 22.492465, :com.wsscode.media-looper.model/loop-finish 44.442242} {:com.wsscode.media-looper.model/loop-id #uuid \\"361ef51b-d379-4b25-9523-f88cb133fc47\\", :com.wsscode.media-looper.model/loop-title \\"New loop\\", :com.wsscode.media-looper.model/loop-start 58.54625, :com.wsscode.media-looper.model/loop-finish 87.687517} {:com.wsscode.media-looper.model/loop-start 20.151186, :com.wsscode.media-looper.model/loop-finish 22.998766, :com.wsscode.media-looper.model/loop-id #uuid \\"e3482de1-00d4-4b5e-a3e2-11e2d88063f2\\", :com.wsscode.media-looper.model/loop-title \\"New loop\\"}]","\\"media-looper:youtube:Irm8wDYL-d8\\"":"[{:com.wsscode.media-looper.model/loop-id #uuid \\"632df4ab-ef84-4b47-9d23-613f9af830f7\\", :com.wsscode.media-looper.model/loop-title \\"Demo 1\\", :com.wsscode.media-looper.model/loop-start 118.68936099999998, :com.wsscode.media-looper.model/loop-finish 135.576819}]","\\"media-looper:youtube:JmtoYWjWfvM\\"":"[{:com.wsscode.media-looper.model/loop-id #uuid \\"a2070ce4-ee56-432e-a470-28f7ae60090d\\", :com.wsscode.media-looper.model/loop-title \\"Musica Inteira\\", :com.wsscode.media-looper.model/loop-start 35.645902, :com.wsscode.media-looper.model/loop-finish 180.852105}]","\\"media-looper:youtube:M3omYbJXGTA\\"":"[{:com.wsscode.media-looper.model/loop-id #uuid \\"25d1a831-8476-4ec0-8584-6503512861f8\\", :com.wsscode.media-looper.model/loop-title \\"csacas\\", :com.wsscode.media-looper.model/loop-start 4.733972, :com.wsscode.media-looper.model/loop-finish 8.64042} {:com.wsscode.media-looper.model/loop-start 6.347704, :com.wsscode.media-looper.model/loop-finish 7.680628, :com.wsscode.media-looper.model/loop-id #uuid \\"dc2d19c9-8c13-40a2-a3be-a93bc651f6e9\\", :com.wsscode.media-looper.model/loop-title \\"New loop\\"}]","\\"media-looper:youtube:M9J6sYkSb-k\\"":"[{:com.wsscode.media-looper.model/loop-id #uuid \\"86d14c10-516f-438e-9588-c0e3c0109fb0\\", :com.wsscode.media-looper.model/loop-title \\"Intro\\", :com.wsscode.media-looper.model/loop-start 3.437359, :com.wsscode.media-looper.model/loop-finish 8.303804}]","\\"media-looper:youtube:NqVkl5Oc3jw\\"":"[{:com.wsscode.media-looper.model/loop-start 0, :com.wsscode.media-looper.model/loop-finish 5.568458999999999, :com.wsscode.media-looper.model/loop-id #uuid \\"95a8f1e4-e742-461a-9dd4-21e875d99bb2\\", :com.wsscode.media-looper.model/loop-title \\"New loop\\"}]","\\"media-looper:youtube:NrgmdOz227I\\"":"[{:com.wsscode.media-looper.model/loop-start 8.012527, :com.wsscode.media-looper.model/loop-finish 12.80366, :com.wsscode.media-looper.model/loop-id #uuid \\"0e717ea3-4196-46a4-8109-f8c3dec72f91\\", :com.wsscode.media-looper.model/loop-title \\"New loop\\"}]","\\"media-looper:youtube:Nz7101ulkK0\\"":"[{:com.wsscode.media-looper.model/loop-start 76.064258, :com.wsscode.media-looper.model/loop-finish 82.164392, :com.wsscode.media-looper.model/loop-id #uuid \\"f6339099-1e86-4de7-bd1a-4c2f1bda3b3e\\", :com.wsscode.media-looper.model/loop-title \\"New loop\\"}]","\\"media-looper:youtube:PE4NhNxBulQ\\"":"[{:com.wsscode.media-looper.model/loop-id #uuid \\"3406a79a-ea3f-47bf-8531-d8ca87eee09e\\", :com.wsscode.media-looper.model/loop-title \\"Introdução\\", :com.wsscode.media-looper.model/loop-start 139.051073, :com.wsscode.media-looper.model/loop-finish 157.808137} {:com.wsscode.media-looper.model/loop-id #uuid \\"8869d20b-d544-4f0a-a3c4-bd9025c3acb4\\", :com.wsscode.media-looper.model/loop-title \\"Primeira Parte\\", :com.wsscode.media-looper.model/loop-start 157.809872, :com.wsscode.media-looper.model/loop-finish 180.483196} {:com.wsscode.media-looper.model/loop-id #uuid \\"9801bacf-58aa-47c6-939a-bdce58d094b8\\", :com.wsscode.media-looper.model/loop-title \\"Segunda parte 6 - 8\\", :com.wsscode.media-looper.model/loop-start 204.19905300000002, :com.wsscode.media-looper.model/loop-finish 206.740854} {:com.wsscode.media-looper.model/loop-id #uuid \\"645461be-dd3f-4977-807d-eaca56096c4c\\", :com.wsscode.media-looper.model/loop-title \\"New loop\\", :com.wsscode.media-looper.model/loop-start 237.040322, :com.wsscode.media-looper.model/loop-finish 241.646059}]","\\"media-looper:youtube:QDAHMMMtFBI\\"":"[{:com.wsscode.media-looper.model/loop-id #uuid \\"f65ebf32-c059-411f-ab13-e9827c8f0e95\\", :com.wsscode.media-looper.model/loop-title \\"Intro\\", :com.wsscode.media-looper.model/loop-start 3.248518, :com.wsscode.media-looper.model/loop-finish 16.752523}]","\\"media-looper:youtube:RkkGVgOqPuM\\"":"[{:com.wsscode.media-looper.model/loop-id #uuid \\"b708bcdb-7808-4e7e-8122-c788b194d99d\\", :com.wsscode.media-looper.model/loop-title \\"New loop\\", :com.wsscode.media-looper.model/loop-start 84.811562, :com.wsscode.media-looper.model/loop-finish 105.309853}]","\\"media-looper:youtube:VmxqhvnfMvI\\"":"[{:com.wsscode.media-looper.model/loop-id #uuid \\"1d089f66-727e-47c8-aead-331b053249cf\\", :com.wsscode.media-looper.model/loop-title \\"New loop\\", :com.wsscode.media-looper.model/loop-start 42.184228, :com.wsscode.media-looper.model/loop-finish 49.80162}]","\\"media-looper:youtube:bBHPq3UQFsw\\"":"[{:com.wsscode.media-looper.model/loop-id #uuid \\"cfe014f3-7980-43f5-967d-8989330828c6\\", :com.wsscode.media-looper.model/loop-title \\"Loop G\\", :com.wsscode.media-looper.model/loop-start 47.200578, :com.wsscode.media-looper.model/loop-finish 52.79042}]","\\"media-looper:youtube:chwyjJbcs1Y\\"":"[{:com.wsscode.media-looper.model/loop-id #uuid \\"038a18f0-a837-4de3-b906-51f40b87516a\\", :com.wsscode.media-looper.model/loop-title \\"New loop\\", :com.wsscode.media-looper.model/loop-start 47.702107, :com.wsscode.media-looper.model/loop-finish 57.252446} {:com.wsscode.media-looper.model/loop-start 186.6739, :com.wsscode.media-looper.model/loop-finish 207.977473, :com.wsscode.media-looper.model/loop-id #uuid \\"ff552725-827d-48a6-9c7d-e17444015a73\\", :com.wsscode.media-looper.model/loop-title \\"New loop\\"}]","\\"media-looper:youtube:f1TcGd1G0Js\\"":"[{:com.wsscode.media-looper.model/loop-id #uuid \\"9abed961-823a-452c-9348-006ff45b2371\\", :com.wsscode.media-looper.model/loop-title \\"Musica Inteira\\", :com.wsscode.media-looper.model/loop-start 49.009665, :com.wsscode.media-looper.model/loop-finish 259.737792} {:com.wsscode.media-looper.model/loop-id #uuid \\"f16e7852-ecd5-429b-aeeb-ccb363b1275e\\", :com.wsscode.media-looper.model/loop-title \\"Primeira Parte 1 - 4\\", :com.wsscode.media-looper.model/loop-start 776.892917, :com.wsscode.media-looper.model/loop-finish 787.967461} {:com.wsscode.media-looper.model/loop-id #uuid \\"ba6eb01c-8df9-474a-a642-ac93c42219b8\\", :com.wsscode.media-looper.model/loop-title \\"Primeira Parte 5 - 7\\", :com.wsscode.media-looper.model/loop-start 787.967, :com.wsscode.media-looper.model/loop-finish 799.829} {:com.wsscode.media-looper.model/loop-id #uuid \\"f8e81103-4148-40ce-b250-24d43e8c9872\\", :com.wsscode.media-looper.model/loop-title \\"Primera Parte Completa\\", :com.wsscode.media-looper.model/loop-start 776.793, :com.wsscode.media-looper.model/loop-finish 799.8389999999999} {:com.wsscode.media-looper.model/loop-id #uuid \\"1ea300a2-6d6f-4f6d-8a27-62f8ae8aee5f\\", :com.wsscode.media-looper.model/loop-title \\"Intro Parte 1\\", :com.wsscode.media-looper.model/loop-start 597.014914, :com.wsscode.media-looper.model/loop-finish 607.909258} {:com.wsscode.media-looper.model/loop-id #uuid \\"083c9ab0-a033-4c97-b027-8f615043b68c\\", :com.wsscode.media-looper.model/loop-title \\"Intro\\", :com.wsscode.media-looper.model/loop-start 617.137358, :com.wsscode.media-looper.model/loop-finish 623.817948} {:com.wsscode.media-looper.model/loop-id #uuid \\"17aa015b-eb71-42d6-b432-18890d7cf6e2\\", :com.wsscode.media-looper.model/loop-title \\"Segunda Parte\\", :com.wsscode.media-looper.model/loop-start 1020.5785689999999, :com.wsscode.media-looper.model/loop-finish 1042.577232} {:com.wsscode.media-looper.model/loop-id #uuid \\"7f87c021-982f-4846-9693-c89103add484\\", :com.wsscode.media-looper.model/loop-title \\"Primeira Parte Letra\\", :com.wsscode.media-looper.model/loop-start 58.085545, :com.wsscode.media-looper.model/loop-finish 93.269215} {:com.wsscode.media-looper.model/loop-id #uuid \\"7e240a6d-c1be-4c28-9c66-27f1e6e1d935\\", :com.wsscode.media-looper.model/loop-title \\"Refrão\\", :com.wsscode.media-looper.model/loop-start 1306.496343, :com.wsscode.media-looper.model/loop-finish 1346.666477} {:com.wsscode.media-looper.model/loop-id #uuid \\"03df96db-3a34-41c2-a0f0-66e789137120\\", :com.wsscode.media-looper.model/loop-title \\"Refrao Partes 1 - 4\\", :com.wsscode.media-looper.model/loop-start 1306.497, :com.wsscode.media-looper.model/loop-finish 1322.9} {:com.wsscode.media-looper.model/loop-id #uuid \\"bd2c0664-6b16-4b86-914c-b8543af2eadd\\", :com.wsscode.media-looper.model/loop-title \\"Refrao Partes 5 - 8\\", :com.wsscode.media-looper.model/loop-start 1322.916787, :com.wsscode.media-looper.model/loop-finish 1336.253575} {:com.wsscode.media-looper.model/loop-id #uuid \\"a1350c8f-5822-4b75-ae4c-3b7fda022849\\", :com.wsscode.media-looper.model/loop-title \\"Refrão 1\\", :com.wsscode.media-looper.model/loop-start 93.458872, :com.wsscode.media-looper.model/loop-finish 127.17561400000005}]","\\"media-looper:youtube:fDFXLMbCG0A\\"":"[{:com.wsscode.media-looper.model/loop-id #uuid \\"0191336b-4dca-443f-8581-76cb03d36be5\\", :com.wsscode.media-looper.model/loop-title \\"first chord - Dm\\", :com.wsscode.media-looper.model/loop-start 0, :com.wsscode.media-looper.model/loop-finish 0.9561909999999999} {:com.wsscode.media-looper.model/loop-id #uuid \\"6bc7e1f0-d9a9-430a-a412-ab922db75621\\", :com.wsscode.media-looper.model/loop-title \\"abrindo - Dm7 G\\", :com.wsscode.media-looper.model/loop-start 9.011116, :com.wsscode.media-looper.model/loop-finish 12.057076} {:com.wsscode.media-looper.model/loop-id #uuid \\"4f88547a-1a49-476e-9fbc-996b447de0a9\\", :com.wsscode.media-looper.model/loop-title \\"New loop\\", :com.wsscode.media-looper.model/loop-start 25.415794, :com.wsscode.media-looper.model/loop-finish 33.88447} {:com.wsscode.media-looper.model/loop-id #uuid \\"fb37af4f-5b53-47ad-9579-d2e43bab6e1a\\", :com.wsscode.media-looper.model/loop-title \\"New loop\\", :com.wsscode.media-looper.model/loop-start 64.344663, :com.wsscode.media-looper.model/loop-finish 73.370632}]","\\"media-looper:youtube:gWvQvxygfQI\\"":"[{:com.wsscode.media-looper.model/loop-start 13.010456999999999, :com.wsscode.media-looper.model/loop-finish 14.844457999999998, :com.wsscode.media-looper.model/loop-id #uuid \\"a8087be4-0add-4a16-93a7-7454f5e0437f\\", :com.wsscode.media-looper.model/loop-title \\"New loop\\"}]","\\"media-looper:youtube:iQmBK3Qv13Y\\"":"[{:com.wsscode.media-looper.model/loop-id #uuid \\"906e07ec-6a4c-475e-90b4-c4e961717094\\", :com.wsscode.media-looper.model/loop-title \\"Intro\\", :com.wsscode.media-looper.model/loop-start 28.930183, :com.wsscode.media-looper.model/loop-finish 43.151088} {:com.wsscode.media-looper.model/loop-start 43.251403, :com.wsscode.media-looper.model/loop-finish 50.436274, :com.wsscode.media-looper.model/loop-id #uuid \\"074597f7-9758-4630-8362-903ae1b73da7\\", :com.wsscode.media-looper.model/loop-title \\"New loop\\"}]","\\"media-looper:youtube:j42byy7G_Ow\\"":"[{:com.wsscode.media-looper.model/loop-id #uuid \\"23800c25-1cf9-4cfb-a19a-1ad012b0de26\\", :com.wsscode.media-looper.model/loop-title \\"New loop\\", :com.wsscode.media-looper.model/loop-start 78.336826, :com.wsscode.media-looper.model/loop-finish 88.394774}]","\\"media-looper:youtube:jhgcATl8pQk\\"":"[{:com.wsscode.media-looper.model/loop-id #uuid \\"bcdbf7a9-1283-4c06-851d-846d1b7bc738\\", :com.wsscode.media-looper.model/loop-title \\"New loop\\", :com.wsscode.media-looper.model/loop-start 13.414215, :com.wsscode.media-looper.model/loop-finish 15.908801}]","\\"media-looper:youtube:k1BneeJTDcU\\"":"[{:com.wsscode.media-looper.model/loop-start 12.490208, :com.wsscode.media-looper.model/loop-finish 16.249813, :com.wsscode.media-looper.model/loop-id #uuid \\"3fea9d40-d2f5-439b-a019-d6df04b05102\\", :com.wsscode.media-looper.model/loop-title \\"New loop\\"}]","\\"media-looper:youtube:kpRGNxqv6Wk\\"":"[{:com.wsscode.media-looper.model/loop-id #uuid \\"72b485bc-0b0d-4405-9f4f-91d9e36c2733\\", :com.wsscode.media-looper.model/loop-title \\"New loop\\", :com.wsscode.media-looper.model/loop-start 63.430109, :com.wsscode.media-looper.model/loop-finish 78.853266}]","\\"media-looper:youtube:ktfhkK1fgGM\\"":"[{:com.wsscode.media-looper.model/loop-id #uuid \\"451ac90d-c12a-4778-b763-bf48c1f040c5\\", :com.wsscode.media-looper.model/loop-title \\"trecho da musica\\", :com.wsscode.media-looper.model/loop-start 99.909185, :com.wsscode.media-looper.model/loop-finish 121.415415}]","\\"media-looper:youtube:lcibpEB9gu0\\"":"[{:com.wsscode.media-looper.model/loop-id #uuid \\"379f7989-a8f6-4344-8024-06316132c22b\\", :com.wsscode.media-looper.model/loop-title \\"Primeira parte\\", :com.wsscode.media-looper.model/loop-start 79.185672, :com.wsscode.media-looper.model/loop-finish 94.644418} {:com.wsscode.media-looper.model/loop-id #uuid \\"c6c81beb-1878-4b4c-9795-1a2bb700cd00\\", :com.wsscode.media-looper.model/loop-title \\"Primeira parte + 1\\", :com.wsscode.media-looper.model/loop-start 79.185672, :com.wsscode.media-looper.model/loop-finish 104.644} {:com.wsscode.media-looper.model/loop-id #uuid \\"160af782-ac6a-484f-9245-af812b77716c\\", :com.wsscode.media-looper.model/loop-title \\"Refrao\\", :com.wsscode.media-looper.model/loop-start 306.58160099999986, :com.wsscode.media-looper.model/loop-finish 318.9826639999998}]","\\"media-looper:youtube:n57aQQsQiwc\\"":"[{:com.wsscode.media-looper.model/loop-id #uuid \\"900452ff-0983-4b5e-a72f-d9dd27fc6611\\", :com.wsscode.media-looper.model/loop-title \\"New loop\\", :com.wsscode.media-looper.model/loop-start 39.789108, :com.wsscode.media-looper.model/loop-finish 40.272072} {:com.wsscode.media-looper.model/loop-start 41.851399, :com.wsscode.media-looper.model/loop-finish 55.000537, :com.wsscode.media-looper.model/loop-id #uuid \\"302bf426-1e08-457a-9776-842cbf05074a\\", :com.wsscode.media-looper.model/loop-title \\"New loop\\"}]","\\"media-looper:youtube:rvJ-W-Q_JYM\\"":"[{:com.wsscode.media-looper.model/loop-start 40.878189, :com.wsscode.media-looper.model/loop-finish 43.063768, :com.wsscode.media-looper.model/loop-id #uuid \\"0250de89-02fc-448a-b0c8-ac38b10afe55\\", :com.wsscode.media-looper.model/loop-title \\"New loop\\"}]","\\"media-looper:youtube:sSqU6vgs3Dc\\"":"[{:com.wsscode.media-looper.model/loop-start 0, :com.wsscode.media-looper.model/loop-finish 389.513954, :com.wsscode.media-looper.model/loop-id #uuid \\"35a1c1fd-49ad-4623-964c-21b21a71eaac\\", :com.wsscode.media-looper.model/loop-title \\"Full Song\\"}]","\\"media-looper:youtube:xHotXbGZiFY\\"":"[{:com.wsscode.media-looper.model/loop-id #uuid \\"f6dbcc71-5730-4224-ace1-d2c7fab867f7\\", :com.wsscode.media-looper.model/loop-title \\"Chorus\\", :com.wsscode.media-looper.model/loop-start 46.327336, :com.wsscode.media-looper.model/loop-finish 59.22878} {:com.wsscode.media-looper.model/loop-id #uuid \\"199f98ae-905f-4032-9208-652ac25b2dcd\\", :com.wsscode.media-looper.model/loop-title \\"Intro\\", :com.wsscode.media-looper.model/loop-start 1, :com.wsscode.media-looper.model/loop-finish 8.06934} {:com.wsscode.media-looper.model/loop-id #uuid \\"b3613205-95b7-4584-ae0d-1676feec2e05\\", :com.wsscode.media-looper.model/loop-title \\"Outro\\", :com.wsscode.media-looper.model/loop-start 137.556905, :com.wsscode.media-looper.model/loop-finish 176.091149}]","\\"media-looper:youtube:zIZjsAFKARU\\"":"[{:com.wsscode.media-looper.model/loop-start 534.113874, :com.wsscode.media-looper.model/loop-finish 540.292, :com.wsscode.media-looper.model/loop-id #uuid \\"6d7164fe-a6fd-4953-980d-d6711d52c5de\\", :com.wsscode.media-looper.model/loop-title \\"New loop\\"}]","\\"media-looper:youtube:ztCiPJUqcTU\\"":"[{:com.wsscode.media-looper.model/loop-id #uuid \\"94f2abc4-1c9c-4db2-a884-ee5445789fee\\", :com.wsscode.media-looper.model/loop-title \\"Intro 1\\", :com.wsscode.media-looper.model/loop-start 373.136072, :com.wsscode.media-looper.model/loop-finish 385.149752} {:com.wsscode.media-looper.model/loop-id #uuid \\"322823be-f2af-49a9-aee7-a40a0c3c38ef\\", :com.wsscode.media-looper.model/loop-title \\"teste com Pri\\", :com.wsscode.media-looper.model/loop-start 88.321128, :com.wsscode.media-looper.model/loop-finish 91.004515} {:com.wsscode.media-looper.model/loop-id #uuid \\"b146247c-022a-4b29-97e4-a0f2ef28c4cc\\", :com.wsscode.media-looper.model/loop-title \\"New loop\\", :com.wsscode.media-looper.model/loop-start 375.810628, :com.wsscode.media-looper.model/loop-finish 379.158523}]"}')

  let media: string | false = false
  let search = ""
  let toImport: any = false

  function downloadDatabase() {
    download('media-looper-backup.json', new Blob([JSON.stringify(store.getMergeableContent())], {type: "application/json"}))
  }

  async function importLoops() {
    const file = await pickFile()
    const content = await readFileText(file)

    const importStore = createMergeableStore()
    importStore.setMergeableContent(JSON.parse(content))

    store.merge(importStore)
  }

  function parseLoops(videoId: string, loopsEdn: string): Loop[] {
    const loops = parseEDNString(loopsEdn as string, { mapAs: 'object', keywordAs: 'string' }) as any[]

    return loops.map((l) => {
      return {
        id: l['com.wsscode.media-looper.model/loop-id'].val,
        startTime: l['com.wsscode.media-looper.model/loop-start'],
        endTime: l['com.wsscode.media-looper.model/loop-finish'],
        label: l['com.wsscode.media-looper.model/loop-title'],
        source: 'youtube:' + videoId
      }
    })
  }

  async function importLoopsPreviousPreview() {
    const data = await browser.storage.sync.get(null)

    // TODO: replace with data
    toImport = keep(Object.entries(storageContents), ([id, x]: [string, any]) => {
      const match = id.match(/media-looper:youtube:([^"]+)/)

      if (!match) return null

      return {sourceId: sourceIdFromVideoId(match[1]), videoId: match[1], loops: parseLoops(match[1], x)}
    })

    console.log('import', toImport);
  }

  function importLoopsPrevious() {
    for (const media of toImport) {
      store.setRow('medias', media.sourceId, {readonly: false})

      for (const {id, ...loop} of media.loops) {
        store.setRow('loops', id, loop)
      }
    }
  }

  const mediaIds = useTable('medias')

  $: medias = Object.entries($mediaIds).filter(([id, r]) => {
    const media = r as unknown as Media

    if (media.title?.toLowerCase().indexOf(search) > -1) return true
    if (media.channel?.toLowerCase().indexOf(search) > -1) return true

    return true
  })

  $: ids = medias.map(([id]) => id)
</script>

<div class="px-10 w-full my-6">
  <Heading tag="h1" class="mb-5">Youtube Looper Dashboard</Heading>

  <div class="my-4">
    <Button on:click={downloadDatabase}>Export database</Button>
    <Button on:click={importLoops}>Import database</Button>
    <Button on:click={importLoopsPreviousPreview}>Import from previous version</Button>
  </div>

  <TableSearch placeholder="Search" hoverable={true} shadow bind:inputValue={search}>
    <TableHead>
      <TableHeadCell></TableHeadCell>
      <TableHeadCell>Channel</TableHeadCell>
      <TableHeadCell>Title</TableHeadCell>
      <TableHeadCell>Loop Count</TableHeadCell>
      <TableHeadCell></TableHeadCell>
    </TableHead>
    <TableBody tableBodyClass="divide-y">
      {#each ids as id (id)}
        <MediaAdmin {id} on:click={() => media = id}/>
      {/each}
    </TableBody>

  </TableSearch>

  <Modal bind:open={media} autoclose outsideclose dismissable={false} size={'xl'} classDialog="outline-0">
    {#if media}
      <YoutubeEmbed videoId={media.substring(8)} />
    {:else}
      <div>Something is wrong, no media selected.</div>
    {/if}
  </Modal>

  <Modal title="Import videos" bind:open={toImport} autoclose outsideclose classDialog="outline-0">
    <div class="flex flex-row flex-wrap justify-between">
      {#each toImport as media}
        <ImportEntry media={media}/>
      {/each}
    </div>

    <svelte:fragment slot="footer">
      <Button on:click={importLoopsPrevious}>Import</Button>
      <Button color="alternative">Cancel</Button>
    </svelte:fragment>
  </Modal>
</div>
